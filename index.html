<!doctype html>
<html lang=en>
<meta charset=utf-8>
<link rel="icon" type="image/png" href="favicon.png">

<style>

body { font-family: sans-serif; margin: 1em 1em 1em 1em; }
.clicky { border: 1px solid black; }

.grid { display: grid; width: 100%; grid-template-columns: max-content max-content; }
.item { padding: 0em 1em 1em 0em; }

table { border-collapse: collapse; }
td { 
    text-align: center; 
    margin: 0; padding: 0; padding-right: 0.5em; 
    vertical-align: top;
}

input[type=radio] {
    width: 1.5em;
    height: 1.5em;
}

input[type=color] {
    width: 3em;
    height: 1.5em;
}

</style>

</style>
<title>ghostsurn</title>
<h1>ghostsurn 0.1</h1>

<div style="float: left; margin-top: 1em; margin-right: 2em; margin-bottom: 2em;">
    <div class=grid>
      <div class=item>Palette</div>
      <div class=item>
        <table>
          <tr>
            <td><input type=color id=pal0 onchange="redraw()"></td>
            <td><input type=color id=pal1 onchange="redraw()"></td>
            <td><input type=color id=pal2 onchange="redraw()"></td>
            <td><input type=color id=pal3 onchange="redraw()"></td>
            <td><input type=color id=pal4 onchange="redraw()"></td>            
            <td>Clear</td>
          </tr>
          <tr>
            <td><input type=radio id=pal_select0 name=pal_select value=0 checked></td>
            <td><input type=radio id=pal_select1 name=pal_select value=1></td>
            <td><input type=radio id=pal_select2 name=pal_select value=2></td>
            <td><input type=radio id=pal_select3 name=pal_select value=3></td>
            <td><input type=radio id=pal_select4 name=pal_select value=4></td>
            <td><input type=radio id=pal_select_ name=pal_select value=_></td>
          </tr>
        </table>
      </div>
      <div class=item>
          Pattern
          <button onclick="enlarge_pattern()" title="enlarge pattern area">+</button>
      </div>
      <div class=item>
          <canvas id=pattern width=60 height=60 class=clicky></canvas>
          
      </div>
      <div class=item>Mask</div>
      <div class=item><canvas id=mask width=60 height=60 class=clicky></canvas></div>
      <div class=item>Rotation</div>
      <div class=item>
        <select id=rotation oninput="recompute()" title="all rotations of both pattern and mask are used">
          <option value="">None</option>
          <option value="90">90° rotations</option>
          <option value="180">180° rotation</option>
        </select>
      </div>
      <div class=item>Width</div>
      <div class=item><input type=number id=width min=1 oninput="recompute()"></div>
      <div class=item>Height</div>
      <div class=item><input type=number id=height min=1 oninput="recompute()"></div>    
      <div class=item>Effort</div>
      <div class=item><input type=number id=effort min=1 oninput="recompute()"></div>
      <div class=item>Scale</div>
      <div class=item><input type=number id=scale min=1 max=100 oninput="redraw()"></div>
      <div class=item></div>
      <div class=item>
        <button id=again onclick="recompute()" title="draw a new sample">Again</button>
        <button id=randomize onclick="randomize()" title="apply variable reinforcement to the user">Randomize pattern</button>
      </div>
    </div>
    
    <div id=status style="width: 20em; border: 1px solid #ddd; background: #f8f8f8; padding: 0.5em;"></div>
</div>

<div style="float: left; margin-top: 1em;">
  <canvas id=plot onmousedown="on_plot_mousedown()"></canvas>
</div>

<div style="float: right; margin-top: 1em;">
  <b>Examples</b><br/><br/>
  <div id=examples></div>
</div>

<p style="clear: left">
This app aims to produce a layout drawn uniformly at random from the set of all possible valid layouts. The randomness of the draw is not 100% perfect, but perfection can be approached by increasing the "effort" parameter.
</p>

<p>
To assess the quality of the resulting layout, click and hold on the layout. If it flickers between many different layouts, especially at the top, it is a decent random sample. If it doesn't then the layout might not be a good representative of the set of all valid layouts and "effort" should be increased.
</p>
  
<script src=sampler.js></script>
<script src=interface.js></script>
<script src=examples.js></script>

<script>
"use strict";

let get = (id) => document.getElementById(id);

let canvas = document.getElementById("plot");
let ctx = canvas.getContext("2d");

let worker = null;
let ready = false;

let result = null;
let which = 0;
let param = { };

let pattern = new Click_map(
    "pattern", null, "_01234", null, null, 
    ()=>document.querySelector('input[name="pal_select"]:checked').value
);
let mask = new Click_map(
    "mask", null, "01", {"0":"#cccccc","1":"black"}, null, null);


function job(command, callback) {
    if (!ready) {
        if (worker !== null) worker.terminate();
        worker = new Worker("worker.js");
        worker.onmessage = function(msg) {
            callback(msg.data);
        }
    }
    ready = false;
    worker.postMessage(command);
}

function read_url() {
    let sp = location.search;
    //if (sp == "") 
    //    sp = examples[0][1];
    
    sp = new URLSearchParams(sp);
    get("rotation").value = sp_get_str(sp, "rotation", "90");
    get("width").value = sp_get_int(sp, "width", 20);
    get("height").value = sp_get_int(sp, "height", 20);
    get("effort").value = sp_get_int(sp, "effort", 100);
    get("scale").value = sp_get_int(sp, "scale", 10);
    get("pal0").value = sp_get_str(sp, "pal0", "#e2d810");
    get("pal1").value = sp_get_str(sp, "pal1", "#d9138a");
    get("pal2").value = sp_get_str(sp, "pal2", "#12a4d9");
    get("pal3").value = sp_get_str(sp, "pal3", "#000000");
    get("pal4").value = sp_get_str(sp, "pal4", "#ffffff");
    
    pattern.pic = sp_get_picture(sp, "pattern", new Picture(5,5,"_"));
    mask.pic = sp_get_picture(sp, "mask", new Picture(5,5,"0"));
}

function update_url() {
    let sp = new URLSearchParams();
    sp.set("rotation",param.rotation);
    sp.set("width",param.width);
    sp.set("height",param.height);
    sp.set("effort",param.effort);
    sp.set("scale",param.scale);
    sp.set("pattern",pattern.pic.get_trim("_").get_string());
    sp.set("mask",mask.pic.get_string());
    sp.set("pal0",param.palette["0"]);
    sp.set("pal1",param.palette["1"]);
    sp.set("pal2",param.palette["2"]);
    sp.set("pal3",param.palette["3"]);
    sp.set("pal4",param.palette["4"]);
    
    let url = new URL(location.href);
    url.search = sp;
    if (url != location.href)
        history.replaceState(history.state, document.title, url);
}

function load_param() {
    param.rotation = get("rotation").value;
    param.width = get("width").value;
    param.height = get("height").value;
    param.effort = get("effort").value;
    param.scale = get("scale").value;
    param.palette = {
        "0": get("pal0").value,
        "1": get("pal1").value,
        "2": get("pal2").value,
        "3": get("pal3").value,
        "4": get("pal4").value,
    };
}

function on_plot_mousedown() {
    function ticker() {
        which = Math.random();
        redraw();
        if (document.body.matches(":active"))
            setTimeout(ticker, 100);
    }

    setTimeout(ticker);
}

function enlarge_pattern() {
    let pic = pattern.pic;
    pattern.pic = new Picture(pic.width+2, pic.height+2, "_");
    for(let y of range(pic.height))
    for(let x of range(pic.width))
        pattern.pic.set(x+1,y+1, pic.get(x,y));
    
    redraw();
}

function redraw() {
    load_param();
    update_url();
    
    let status = "";
    if (result !== null && result.finished && result.words.length == 0)
        status = `Failed to find a layout.`;
    else if (result !== null && result.finished)
        status = `Success.`;
    else if (result !== null)
        status = `Running...`;
    else if (worker !== null && !ready)
        status = `Running...`;
        
    if (result !== null)
        status += "<br><br>"+result.comment;
    
    document.getElementById("status").innerHTML = `${status}`;
    
    pattern.palette = {"_":"#cccccc", ...param.palette};
    pattern.redraw();
    mask.redraw();

    canvas.width = param.width*param.scale;
    canvas.height = param.height*param.scale;
    
    if (result === null || result.words.length > 0)
        ctx.fillStyle = "#f8f8f8";
    else
        ctx.fillStyle = "#ffffff"    
    ctx.fillRect(0,0,canvas.width,canvas.height);
    
    if (result === null) return;
    
    if (result.words.length == 0) return;
    
    let scale = param.scale;
    let word = result.words[ Math.floor(result.words.length*which) ];
    
    outer: for(let y of range(result.height)) {
        for(let x of range(result.width)) {
            if (y*result.width+x >= word.length) break outer;
            
            ctx.fillStyle = param.palette[word[y*result.width+x]];
            ctx.fillRect(x*scale,y*scale,scale,scale);
        }
    }
}

function get_rotations(pic, rotation) {
    let pics = [ pic ];
    if (rotation == "90") {
        for(let i of range(3))
            pics.push( pics[pics.length-1].get_rot() );
    } else if (param.rotation == "180") {
        pics.push( pics[pics.length-1].get_rot().get_rot() );
    }
    
    return pics;
}

function recompute() {
    load_param();
    result = null;
    
    let maskpics = get_rotations(mask.pic, param.rotation);
    let patpics = get_rotations(pattern.pic, param.rotation);    

    let specs = [ ];
    
    for(let maskpic of maskpics) {
        maskpic = maskpic.get_trim("0");
        
        let xs = [ ];
        let ys = [ ];
        for(let y of range(maskpic.height)) {
            for(let x of range(maskpic.width)) {
                if (maskpic.get(x,y) != "0") {
                    xs.push(x);
                    ys.push(y);
                }
            }
        }
        
        if (xs.length == 0) continue;
        
        let valids = new Set();
        for(let patpic of patpics) {
            for(let y=1-maskpic.height;y<patpic.height;y++) {
                for(let x=1-maskpic.width;x<patpic.width;x++) {
                    let word = "";
                    for(let i of range(xs.length))
                    if (x+xs[i] < 0 || x+xs[i] >= patpic.width || y+ys[i] < 0 || y+ys[i] >= patpic.height)
                        word += "_"
                    else
                        word += patpic.get(x+xs[i],y+ys[i]);
                    
                    if (word.search("_") < 0)
                        valids.add(word);
                }
            }
        }
        
        valids = Array.from(valids);
        
        specs.push({xs,ys,valids});
    }
    
    let specs_str = JSON.stringify(specs);
    let command = `run_job(${param.width}, ${param.height}, ${specs_str}, ${param.effort})`;
    job(command, (msg)=> {
        result = msg;
        if (result.finished)
            ready = true;
        redraw();
    });
    
    redraw();
}


function randomize() {
    let pool = [ ];
    for(let y of range(pattern.pic.height))
    for(let x of range(pattern.pic.width))
    if (pattern.pic.get(x,y) != "_") {
        pool.push(pattern.pic.get(x,y));
    }
    
    shuffle(pool);
    
    let i=0;
    
    for(let y of range(pattern.pic.height))
    for(let x of range(pattern.pic.width))
    if (pattern.pic.get(x,y) != "_") {
        pattern.pic.set(x,y, pool[i++]);
    }

    recompute();
}

pattern.onchange = recompute;
mask.onchange = recompute;

for(let item of examples)
    get("examples").innerHTML += `<a href="?${item[1]}">${item[0]}</a><br/>`;

read_url();
recompute();
</script>
