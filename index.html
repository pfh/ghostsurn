<!doctype html>
<html lang=en>
<meta charset=utf-8>
<style>
body { font-family: sans-serif; margin: 1em 1em 1em 1em; }
.clicky { border: 1px solid black; }

.grid { display: grid; width: 100%; grid-template-columns: max-content max-content; }
.item { padding: 0em 1em 1em 0em; }
</style>

</style>
<title>ghostsurn</title>
<h1>ghostsurn</h1>

<div style="float: left; margin-right: 2em; margin-bottom: 2em;">
    <div class=grid>
      <div class=item>Pattern</div>
      <div class=item><canvas id=pattern width=60 height=60 class=clicky></canvas></div>
      <div class=item>Mask</div>
      <div class=item><canvas id=mask width=60 height=60 class=clicky></canvas></div>
      <div class=item>Palette</div>
      <div class=item>
        <input type=color id=pal0 onchange="redraw()">
        <input type=color id=pal1 onchange="redraw()">
        <input type=color id=pal2 onchange="redraw()">
      </div>
      <div class=item>Width</div>
      <div class=item><input type=number id=width min=1 onchange="recompute()"></div>
      <div class=item>Height</div>
      <div class=item><input type=number id=height min=1 onchange="recompute()"></div>    
      <div class=item>Effort</div>
      <div class=item><input type=number id=effort min=1 onchange="recompute()"></div>
      <div class=item>Scale</div>
      <div class=item><input type=number id=scale min=1 max=100 onchange="redraw()"></div>
      <div class=item></div>
      <div class=item><button id=again onclick="recompute()">Again</button></div>
    </div>
</div>

<div>
  <canvas id=plot onmousedown="on_plot_mousedown()"></canvas>
</div>

<p>&nbsp;</p>

<script src=sampler.js></script>
<script src=interface.js></script>

<script>
"use strict";

let canvas = document.getElementById("plot");
let ctx = canvas.getContext("2d");

let worker = null;
let ready = false;

let result = null;
let which = 0;
let param = { };

let pattern = new Click_map(
    "pattern", new Picture(10,10,"_"), "_012", null, null);
let mask = new Click_map(
    "mask", new Picture(5,5, "0"), "01", {"0":"#cccccc","1":"black"}, null);

function job(command, callback) {
    if (!ready) {
        if (worker !== null) worker.terminate();
        worker = new Worker("worker.js");
        worker.onmessage = function(msg) {
            callback(msg.data);
            ready = true;
        }
    }
    ready = false;
    worker.postMessage(command);
}

function read_url() {
    let sp = new URLSearchParams(location.search);
    document.getElementById("width").value = sp_get_int(sp, "width", 20);
    document.getElementById("height").value = sp_get_int(sp, "height", 20);
    document.getElementById("effort").value = sp_get_int(sp, "effort", 100);
    document.getElementById("scale").value = sp_get_int(sp, "scale", 10);
    document.getElementById("pal0").value = sp_get_str(sp, "pal0", "#eeffff");
    document.getElementById("pal1").value = sp_get_str(sp, "pal1", "#0000ff");
    document.getElementById("pal2").value = sp_get_str(sp, "pal2", "#008800");

    pattern.pic.word = sp_get_fixed_str(sp, "pattern", "_".repeat(pattern.pic.width*pattern.pic.height));
    mask.pic.word = sp_get_fixed_str(sp, "mask", "0".repeat(mask.pic.width*mask.pic.height));
}

function update_url() {
    let sp = new URLSearchParams();
    sp.set("width",param.width);
    sp.set("height",param.height);
    sp.set("effort",param.effort);
    sp.set("scale",param.scale);
    sp.set("pattern",pattern.pic.word);
    sp.set("mask",mask.pic.word);
    sp.set("pal0",param.palette["0"]);
    sp.set("pal1",param.palette["1"]);
    sp.set("pal2",param.palette["2"]);

    let url = new URL(location);
    url.search = sp;
    history.replaceState(history.state, document.title, url);
}

function load_param() {
    param.width = document.getElementById("width").value;
    param.height = document.getElementById("height").value;
    param.effort = document.getElementById("effort").value;
    param.scale = document.getElementById("scale").value;
    param.palette = {
        "0": document.getElementById("pal0").value,
        "1": document.getElementById("pal1").value,
        "2": document.getElementById("pal2").value,
    };
}

function on_plot_mousedown() {
    function ticker() {
        which = Math.random();
        redraw();
        if (document.body.matches(":active"))
            setTimeout(ticker, 100);
    }

    setTimeout(ticker);
}

function redraw() {
    load_param();
    update_url();

    pattern.palette = {"_":"#cccccc", ...param.palette};
    pattern.redraw();
    mask.redraw();

    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (result === null) return;

    if (result.words.length == 0) return;

    let scale = param.scale;
    let word = result.words[ Math.floor(result.words.length*which) ];

    canvas.width = result.width*scale;
    canvas.height = result.height*scale;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    for(let y of range(result.height)) {
        for(let x of range(result.width)) {
            ctx.fillStyle = param.palette[word[y*result.width+x]];
            ctx.fillRect(x*scale,y*scale,scale,scale);
        }
    }
}

function recompute() {
    load_param();
    result = null;
    redraw();

    let patpics = [ pattern.pic ];
    for(let i of range(3))
        patpics.push( patpics[patpics.length-1].get_rot() );

    let valids = new Set();
    for(let patpic of patpics) {
        for(let y of range(patpic.height-1)) {
            for(let x of range(patpic.width-1)) {
                let word = patpic.get_part(x,y,2,2).word;
                if (word.search("_") < 0)
                    valids.add(word);
            }
        }
    }

    console.log(valids);

    let valids_str = JSON.stringify(Array.from(valids));
    let command = `new Validity(${param.width},${param.height}, 2,2, "012", ${valids_str}).sample(${param.effort})`;
    job(command, (msg)=> {
        result = msg;
        redraw();
    });
}


pattern.onchange = recompute;
mask.onchange = recompute;

read_url();
recompute();
</script>
