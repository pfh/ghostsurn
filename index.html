<!doctype html>
<html lang=en>
<meta charset=utf-8>
<link rel="icon" type="image/png" href="favicon.png">

<style>
body { font-family: sans-serif; margin: 1em 1em 1em 1em; }
.clicky { border: 1px solid black; }

.grid { display: grid; width: 100%; grid-template-columns: max-content max-content; }
.item { padding: 0em 1em 1em 0em; }
</style>

</style>
<title>ghostsurn</title>
<h1>ghostsurn</h1>

<div style="float: left; margin-right: 2em; margin-bottom: 2em;">
    <div class=grid>
      <div class=item>Palette</div>
      <div class=item>
        <input type=color id=pal0 onchange="redraw()">
        <input type=color id=pal1 onchange="redraw()">
        <input type=color id=pal2 onchange="redraw()">
      </div>
      <div class=item>Pattern</div>
      <div class=item><canvas id=pattern width=60 height=60 class=clicky></canvas></div>
      <div class=item>Mask</div>
      <div class=item><canvas id=mask width=60 height=60 class=clicky></canvas></div>
      <div class=item>Rotation</div>
      <div class=item>
        <select id=rotation oninput="recompute()">
          <option value="">None</option>
          <option value="90">90° rotations</option>
          <option value="180">180° rotation</option>
        </select>
      </div>
      <div class=item>Width</div>
      <div class=item><input type=number id=width min=1 oninput="recompute()"></div>
      <div class=item>Height</div>
      <div class=item><input type=number id=height min=1 oninput="recompute()"></div>    
      <div class=item>Effort</div>
      <div class=item><input type=number id=effort min=1 oninput="recompute()"></div>
      <div class=item>Scale</div>
      <div class=item><input type=number id=scale min=1 max=100 oninput="redraw()"></div>
      <div class=item></div>
      <div class=item>
        <button id=again onclick="recompute()" title="draw a new sample">Again</button>
        <button id=randomize onclick="randomize()" title="apply variable reinforcement to the user">Randomize pattern</button>
      </div>
    </div>
    
    <div id=status style="border: 1px solid #ddd; background: #f8f8f8; padding: 0.5em;"></div>
</div>

<div>
  <canvas id=plot onmousedown="on_plot_mousedown()"></canvas>
</div>

<p style="clear: both">
This app aims to produce a layout drawn uniformly at random from the set of all possible valid layouts. The randomness of the draw is not 100% perfect, but perfection can be approached by increasing the "effort" parameter.
</p>

<p>
To assess the quality of the resulting layout, click and hold on the layout. If it flickers between many different layouts, especially at the top, it is a decent random sample. If it doesn't then the layout might not be a good representative of the set of all valid layouts and "effort" should be increased.
</p>

<script src=sampler.js></script>
<script src=interface.js></script>

<script>
"use strict";

let canvas = document.getElementById("plot");
let ctx = canvas.getContext("2d");

let worker = null;
let ready = false;

let result = null;
let which = 0;
let param = { };

let pattern = new Click_map(
    "pattern", null, "_012", null, null);
let mask = new Click_map(
    "mask", null, "01", {"0":"#cccccc","1":"black"}, null);

function job(command, callback) {
    if (!ready) {
        if (worker !== null) worker.terminate();
        worker = new Worker("worker.js");
        worker.onmessage = function(msg) {
            callback(msg.data);
        }
    }
    ready = false;
    worker.postMessage(command);
}

function read_url() {
    let sp = new URLSearchParams(location.search);
    document.getElementById("rotation").value = sp_get_str(sp, "rotation", "90");
    document.getElementById("width").value = sp_get_int(sp, "width", 20);
    document.getElementById("height").value = sp_get_int(sp, "height", 20);
    document.getElementById("effort").value = sp_get_int(sp, "effort", 100);
    document.getElementById("scale").value = sp_get_int(sp, "scale", 10);
    document.getElementById("pal0").value = sp_get_str(sp, "pal0", "#eeffff");
    document.getElementById("pal1").value = sp_get_str(sp, "pal1", "#0000ff");
    document.getElementById("pal2").value = sp_get_str(sp, "pal2", "#008800");
    
    pattern.pic = sp_get_picture(sp, "pattern", new Picture(10,10,"_"));
    mask.pic = sp_get_picture(sp, "mask", new Picture(5,5,"0"));
}

function update_url() {
    let sp = new URLSearchParams();
    sp.set("rotation",param.rotation);
    sp.set("width",param.width);
    sp.set("height",param.height);
    sp.set("effort",param.effort);
    sp.set("scale",param.scale);
    sp.set("pattern",pattern.pic.get_string());
    sp.set("mask",mask.pic.get_string());
    sp.set("pal0",param.palette["0"]);
    sp.set("pal1",param.palette["1"]);
    sp.set("pal2",param.palette["2"]);
    
    let url = new URL(location.href);
    url.search = sp;
    if (url != location.href)
        history.replaceState(history.state, document.title, url);
}

function load_param() {
    param.rotation = document.getElementById("rotation").value;
    param.width = document.getElementById("width").value;
    param.height = document.getElementById("height").value;
    param.effort = document.getElementById("effort").value;
    param.scale = document.getElementById("scale").value;
    param.palette = {
        "0": document.getElementById("pal0").value,
        "1": document.getElementById("pal1").value,
        "2": document.getElementById("pal2").value,
    };
}

function on_plot_mousedown() {
    function ticker() {
        which = Math.random();
        redraw();
        if (document.body.matches(":active"))
            setTimeout(ticker, 100);
    }

    setTimeout(ticker);
}

function redraw() {
    load_param();
    update_url();
    
    let status = "";
    if (result !== null && result.finished && result.words.length == 0)
        status = `Failed to find a layout`;
    else if (result !== null && result.finished)
        status = `Success`;
    else if (result !== null)
        status = `Running`;
    else if (worker !== null && !ready)
        status = `Running`;
    document.getElementById("status").innerHTML = `${status}`;
    
    pattern.palette = {"_":"#cccccc", ...param.palette};
    pattern.redraw();
    mask.redraw();
    
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    if (result === null) return;
    
    if (result.words.length == 0) return;
    
    let scale = param.scale;
    let word = result.words[ Math.floor(result.words.length*which) ];
    
    canvas.width = result.width*scale;
    canvas.height = result.height*scale;
    
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    outer: for(let y of range(result.height)) {
        for(let x of range(result.width)) {
            if (y*result.width+x >= word.length) break outer;
            
            ctx.fillStyle = param.palette[word[y*result.width+x]];
            ctx.fillRect(x*scale,y*scale,scale,scale);
        }
    }
}

function recompute() {
    load_param();
    result = null;
    
    let xs = [ ];
    let ys = [ ];
    for(let y of range(mask.pic.height)) {
        for(let x of range(mask.pic.width)) {
            if (mask.pic.get(x,y) != "0") {
                xs.push(x);
                ys.push(y);
            }
        }
    }
    
    let minx = Math.min(mask.pic.width, ...xs);
    xs = xs.map(x => x-minx);
    let miny = Math.min(mask.pic.height, ...ys);
    ys = ys.map(y => y-miny);
    
    let maxx = Math.max(0, ...xs);
    let maxy = Math.max(0, ...ys);
     
    let patpics = [ pattern.pic ];
    if (param.rotation == "90") {
        for(let i of range(3))
            patpics.push( patpics[patpics.length-1].get_rot() );
    } else if (param.rotation == "180") {
        patpics.push( patpics[patpics.length-1].get_rot().get_rot() );
    }
    
    let valids = new Set();
    for(let patpic of patpics) {
        for(let y of range(patpic.height-maxy-1)) {
            for(let x of range(patpic.width-maxx-1)) {
                //let word = patpic.get_part(x,y,2,2).word;
                let word = "";
                for(let i of range(xs.length))
                    word += patpic.get(x+xs[i],y+ys[i]);
                if (word.search("_") < 0)
                    valids.add(word);
            }
        }
    }
    
    let xs_str = JSON.stringify(xs);
    let ys_str = JSON.stringify(ys);
    let valids_str = JSON.stringify(Array.from(valids));
    let command = `run_job(
        ${param.width}, ${param.height}, 
        ${xs_str}, ${ys_str}, ${valids_str}, ${param.effort})`;
    job(command, (msg)=> {
        result = msg;
        if (result.finished)
            ready = true;
        redraw();
    });
    
    redraw();
}


function randomize() {
    for(let y of range(pattern.pic.height))
    for(let x of range(pattern.pic.width))
    if (pattern.pic.get(x,y) != "_") {
        pattern.pic.set(x,y, random_choice("012"));
    }

    recompute();
}

pattern.onchange = recompute;
mask.onchange = recompute;

read_url();
recompute();
</script>
